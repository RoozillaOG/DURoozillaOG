# param(
#   [Parameter(Mandatory=$true)][string]$LuaFile,
#   [string]$OutputFile,
#   [switch]$CopyToClipboard)

class MergedScript {
  [string[]]$Requires = @()
  [hashtable]$ScriptPieces = @{}
  [string[]]$Script = @()
  [string]$Name

  [void]DoMerge(
    [string]$Path)
  {
    $processed = @()
    foreach($require in $this.Requires) {
      if(-not $processed.Contains($require))
      {
        $processed += $require
        if($require -ne $this.Name) {
          $this.Script += "`n--== start require ==--`n"
          $this.Script += "--== require $require ==--"
        }
        $this.Script += $this.ScriptPieces[$require] -join "`n"
        if($require -ne $this.Name) {
          $this.Script += "`n--== end require ==--`n"
        }
      }
    }
  }

  [void]GetRequires(
    [string]$Path)
  {
    if($this.Requires.Contains($Path)) {
      # Move to the top of list, already been processed, but dependency moved up
      Write-Host "Moving dependency $Path to top"
      $this.Requires = @($Path) + $this.Requires
      return
    }

    $scriptContent = (Get-Content -Path $Path)
    $newContent = $scriptContent | Select-String -NotMatch ".*-- mock variable"
    $requireList = @()
    $requireList = $scriptContent -match "^require `".*.lua`""
    if($requireList -ne "False") {
      foreach($require in $requireList) {
        Write-Host "Processing dependency $require"
        if($require -match "^require `"(?<path>.*.lua)`"") {
          Write-Host "  - local dependency"
          if(Test-Path "$((Get-Item $Path).Directory)/$($Matches.path)") {
            if(-not $require.Contains("Mock")) {
              Write-Host "  - Including content from $((Get-Item $Path).Directory)/$($Matches.path)"
              $this.GetRequires("$((Get-Item $Path).Directory)/$($Matches.path)")
            }
            else {
              Write-Host "  - ignoring mock data"
            }
            Write-Host "  - Removing require reference "
            $newContent = ($newContent | Select-string -NotMatch "^require `".*$(Split-Path $Matches.path -Leaf)`"")
          }
        }
      }
    }
    $this.Requires += $Path
    $this.ScriptPieces[$Path] = $newContent
  }

  MergedScript(
    [string]$Path)
  {
    $this.Name = $Path
    $this.GetRequires($Path)
    $this.DoMerge($Path)
  }
}

class UnMergedScript {
  [hashtable]$Files = @{}

  UnMergedScript(
    [string]$Content)
  {
    $parts = ($Content -split "--== ADD.* ==--")
    foreach($part in $parts) {
      $lines = ($part -split "--== END")[0] -split "`n"
      $require = $lines[0] -match "(<?require>.*) ==--"
      $lines = $lines | Select-String -NotMatch "(<?require>.*) ==--"
      $this.Files[$require] = $lines -join "`n"
    }
  }

  [void]Write()
  {
    foreach($file in $this.Files.Keys)
    {
      Write-Host "Writing file ${file}"
      if(Test-Path $file)
      {

      }
      else {
        Write-Error "Failed to find require file ${file}"
      }
    }
  }
}

function Invoke-Build(
  [string]$Path,
  [switch]$CopytoClipboard) 
{
  if(Test-Path -Path .\Merged.lua) {
    Remove-Item -Path .\Merged.lua
  }

  $files = ""
  if($Path) {
    $files = Get-Item -Path $Path
  }
  else {
    $files = Get-ChildItem . -Filter *.lua
    $scripts = @()
  }
  
  foreach($file in $files) {
    Write-Host "Processing script $($file.Name)"
    $scripts += [MergedScript]::new($file.Name)
  }

  "" | Set-Content .\Merged.lua
  foreach($script in $scripts) {
    @"
----- $($script.Name) ----
$($script.Script -join "`n")

--------------------------


"@ | Add-Content .\Merged.lua

  }

  if($CopytoClipboard) {
    Get-Content .\Merged.lua | Set-Clipboard
  }
}



class PBCodeFile {
  [int]$HandlerKey
  [string]$FileName
  [string]$Code

  PBCodeFile(
    [PSObject]$PB,
    [PSObject]$Handler)
  {
    $slot = $($handler.filter.slotKey)
    $slotName = $($PB.slots.$slot.name)
    $this.HandlerKey = $handler.key
    $this.FileName = @(
      $slotName,
      ($handler.filter.signature -replace "\(|\)","_"),
      $handler.key,
      "lua"
    ) -join "."

    $this.Code = $handler.code
  }

  [void]Write(
    [bool]$Overwrite) 
  {
    if(Test-Path $this.FileName) {
      if($Overwrite) {
        $this.Code | Set-Content $this.FileName
      }
    }
    else {
      $this.Code | Set-Content $this.FileName
    }
  }

  [void]Read()
  {
    $merged = [MergedScript]::new($this.FileName)
    $this.Code = $merged.Script
  }
}

class PBFile {
  [PSObject]$PBContents
  [PBCodeFile[]]$CodeFiles

  static [PBFile]FromFile(
    [string]$Path)
  {
    return [PBFile]::FromString((Get-Content -Path $Path))
  }

  static [PbFile]FromString(
    [string]$Data)
  {
    $pbFile = [PBFile]::new()
    $pb = ($Data) | ConvertFrom-Json
    $pbFile.PBContents = $pb
    foreach($handler in $pb.handlers) {
      $pbFile.CodeFiles += [PBCodeFile]::new($pb, $handler)
    }

    return $pbFile
  }

  [void]WriteCodeFiles(
    [bool]$Overwrite)
  {
    $this.CodeFiles.Write($Overwrite)
  }

  [void]ReadCodeFiles() 
  {
    $this.CodeFiles.Read()
    foreach($code in $this.CodeFiles) {
      $handler = $this.PBContents.handlers | Where-Object {$_.key -eq $code.HandlerKey}
      $handler.Code = $code.Code
    }
  }
}

function Invoke-PBDeconstruct(
  [string]$Path = "./PB.json",
  [switch]$FromClipboard,
  [switch]$Overwrite)
{
  if($FromClipboard) {
    $pb = [PBFile]::FromString((Get-Clipboard))
  }
  else {
    $pb = [PBFile]::FromFile($Path)
  }

  $pb.WriteCodeFiles($Overwrite.IsPresent)
}

function Invoke-PBConstruct(
  [string]$Path = "./PB.json",
  [switch]$ToClipboard)
{
  $pb = [PBFile]::FromFile($Path)
  $pb.ReadCodeFiles()
  
  $json = $pb.PBContents | ConvertTo-Json -Depth 10
  if($ToClipboard) {
    $json | Set-Clipboard
  }
  else {
    $json | Set-Content $Path
  }
}